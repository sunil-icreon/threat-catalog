import { IVulnerabilityType } from "@/types/vulnerability";
import { ECOSYSTEM_COLOR, ECOSYSTEM_NAME } from "@/utilities/constants";
import { EPSSData, formatRelativeTime, getEPSSRisk } from "@/utilities/util";
import { memo, useCallback } from "react";
import { Badge, Button, Card } from "react-bootstrap";
import { CountPill } from "./shared/UtilityComponents";
import { PackageDetailLink } from "./shared/PackageDetailLink";

interface VulnerabilityCardProps {
  index: number;
  vulnerability: IVulnerabilityType;
  onVulnerabilityClick?: (vulnerability: IVulnerabilityType) => void;
}

export const severityVariants = {
  CRITICAL: "danger",
  HIGH: "warning",
  MEDIUM: "info",
  LOW: "success"
} as const;

const statusVariants = {
  ACTIVE: "danger",
  RESOLVED: "success",
  MITIGATED: "primary"
} as const;

const VulnerabilityCard = memo(function VulnerabilityCard({
  vulnerability,
  index,
  onVulnerabilityClick
}: VulnerabilityCardProps) {
  const formatCVSSScore = (cvss: any) => {
    if (!cvss) return null;
    return (
      vulnerability.score ||
      cvss.score ||
      cvss.cvss_v4?.score ||
      cvss.cvss_v3?.score
    );
  };

  const cvssScore = formatCVSSScore(
    vulnerability.cvss || vulnerability.cvss_severities
  );

  const severityLower = vulnerability.severity.toLowerCase();
  const epssData = vulnerability?.epss
    ? getEPSSRisk(vulnerability.epss as EPSSData)
    : null;

  const handleViewDetail = useCallback(
    (e: React.MouseEvent<HTMLButtonElement>) => {
      e.preventDefault();
      e.stopPropagation();
      // Prevent any scroll behavior
      const scrollY = window.scrollY;
      onVulnerabilityClick?.(vulnerability);
      // Restore scroll position immediately if it changed
      requestAnimationFrame(() => {
        if (window.scrollY !== scrollY) {
          window.scrollTo({ top: scrollY, behavior: 'instant' });
        }
      });
    },
    [vulnerability, onVulnerabilityClick]
  );

  return (
    <Card
      className={`custom-card mb-3 h-100 compact-vuln-card ${
        onVulnerabilityClick ? "cursor-pointer" : ""
      }`}
      style={{ minHeight: '180px' }}
    >
      <Card.Body className='d-flex flex-column p-2' style={{ minHeight: '180px' }}>
        {/* Header: Severity Badge, CVSS, EPSS */}
        <div className='d-flex flex-wrap align-items-center gap-2 mb-2'>
          <Badge
            bg={severityVariants[vulnerability.severity as keyof typeof severityVariants] || "secondary"}
            className={`severity-badge-compact severity-${severityLower}`}
          >
            {vulnerability.severity}
          </Badge>
          {cvssScore && (
            <Badge bg='secondary' className='cvss-badge-compact' aria-label={`CVSS Score: ${cvssScore}`}>
              <i className='bi bi-shield-exclamation me-1' aria-hidden='true'></i>
              {cvssScore}
            </Badge>
          )}
          {epssData && (
            <Badge
              bg='secondary'
              className={`epss-badge-compact epss-${epssData.risk.toLowerCase()}`}
              aria-label={`EPSS Score: ${epssData.score}%, Risk Level: ${epssData.risk}`}
            >
              EPSS: {epssData.score}%
            </Badge>
          )}
        </div>

        {/* Package Name - Prominent */}
        <div className='mb-2'>
          <div className='fw-bold text-dark' style={{ fontSize: "0.95rem" }}>
            <PackageDetailLink
              ecoSystem={vulnerability.ecosystem}
              packageName={vulnerability.packageName}
            />
          </div>
          {vulnerability.summary && (
            <div
              className='text-muted small mt-1'
              style={{ fontSize: "0.8rem", lineHeight: "1.3" }}
            >
              {vulnerability.summary}
            </div>
          )}
        </div>

        {/* Affected Versions and Patched Version */}
        {vulnerability.affectedVersions &&
          vulnerability.affectedVersions.length > 0 && (
            <div className='mb-2'>
              <div className='d-flex flex-wrap align-items-center gap-1 mb-1'>
                <span className='small text-muted fw-semibold'>Affected:</span>
                {vulnerability.affectedVersions
                  .filter(Boolean)
                  .slice(0, 3)
                  .map((aff: string) => {
                    return aff.split(",").slice(0, 2).map((affected: string) => (
                      <code
                        className='version vulnerable'
                        key={affected}
                        style={{ fontSize: "0.7rem" }}
                      >
                        {affected}
                      </code>
                    ));
                  })}
                {vulnerability.affectedVersions.filter(Boolean).length > 3 && (
                  <span className='small text-muted'>
                    +{vulnerability.affectedVersions.filter(Boolean).length - 3} more
                  </span>
                )}
              </div>
              {vulnerability.patchedVersion ? (
                <div className='d-flex align-items-center gap-1'>
                  <span className='small text-muted fw-semibold'>Fixed:</span>
                  <PackageDetailLink
                    ecoSystem={vulnerability.ecosystem}
                    packageName={vulnerability.packageName}
                    label={vulnerability.patchedVersion}
                    version={vulnerability.patchedVersion}
                    className='text-success small text-decoration-none fw-semibold'
                  />
                </div>
              ) : (
                <div className='small text-danger fw-semibold'>
                  No Fix Available
                </div>
              )}
            </div>
          )}

        {/* Metadata Row: ID, Ecosystem, Published */}
        <div className='d-flex flex-wrap align-items-center gap-2 mb-2 small text-muted'>
          {vulnerability.id && (
            <span>
              {vulnerability.detailURL ? (
                <a
                  href={vulnerability.detailURL}
                  target='_blank'
                  className='text-decoration-none text-muted'
                  onClick={(e) => e.stopPropagation()}
                  aria-label={`View vulnerability details for ${vulnerability.id}`}
                >
                  {vulnerability.id}
                </a>
              ) : (
                vulnerability.id
              )}
            </span>
          )}
          <span aria-hidden='true'>•</span>
          <CountPill
            count={
              ECOSYSTEM_NAME[vulnerability.ecosystem] ?? vulnerability.ecosystem
            }
            variant={ECOSYSTEM_COLOR[vulnerability.ecosystem] ?? "grey"}
            className='compact-pill'
            aria-label={`Ecosystem: ${ECOSYSTEM_NAME[vulnerability.ecosystem] ?? vulnerability.ecosystem}`}
          />
          <span aria-hidden='true'>•</span>
          <span aria-label={`Published: ${formatRelativeTime(vulnerability.publishedDate)}`}>
            {formatRelativeTime(vulnerability.publishedDate)}
          </span>
        </div>

        {/* Footer: View Details Button */}
        <div className='mt-auto pt-2 border-top'>
          <Button
            onClick={handleViewDetail}
            variant='link'
            type='button'
            className='w-100 p-0 text-decoration-none'
            style={{ fontSize: "0.8rem" }}
            aria-label={`View details for ${vulnerability.packageName} vulnerability ${vulnerability.id}`}
          >
            <i className='bi bi-arrow-right-circle me-1' aria-hidden='true'></i>
            View Details
          </Button>
        </div>
      </Card.Body>
    </Card>
  );
});

VulnerabilityCard.displayName = "VulnerabilityCard";

export default VulnerabilityCard;
