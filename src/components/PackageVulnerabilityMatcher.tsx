"use client";

import { actionGetPackages } from "@/app/actions/vulnerabilities.action";
import { IVulnerabilityType, PackageInfo } from "@/types/vulnerability";
import { ECOSYSTEM_NAME } from "@/utilities/constants";
import { useEffect, useMemo, useState } from "react";
import { Alert, Badge, Button, Card } from "react-bootstrap";
import * as semver from "semver";

interface PackageVulnerabilityMatcherProps {
  vulnerabilities: IVulnerabilityType[];
  onVulnerabilityClick?: (vulnerability: IVulnerabilityType) => void;
}

interface MatchedPackage {
  package: PackageInfo;
  matchedVulnerabilities: IVulnerabilityType[];
}

export default function PackageVulnerabilityMatcher({
  vulnerabilities,
  onVulnerabilityClick
}: PackageVulnerabilityMatcherProps) {
  const [packages, setPackages] = useState<PackageInfo[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  // Fetch packages from server action
  useEffect(() => {
    const fetchPackages = async () => {
      try {
        setLoading(true);
        setError(null);
        const data = await actionGetPackages();
        setPackages(data.packages || []);
      } catch (err) {
        console.error("Error fetching packages:", err);
        setError(
          err instanceof Error ? err.message : "Failed to fetch packages"
        );
        setPackages([]);
      } finally {
        setLoading(false);
      }
    };

    fetchPackages();
  }, []);

  const matchedPackages = useMemo(() => {
    if (
      !packages ||
      packages.length === 0 ||
      !vulnerabilities ||
      vulnerabilities.length === 0
    ) {
      return [];
    }

    const matches: MatchedPackage[] = [];

    packages.forEach((pkg) => {
      const matchedVuls: IVulnerabilityType[] = [];

      vulnerabilities.forEach((vul) => {
        // Match by package name (case-insensitive) and ecosystem
        const nameMatches =
          vul.packageName.toLowerCase() === pkg.name.toLowerCase();
        const ecosystemMatches =
          !pkg.ecosystem ||
          vul.ecosystem.toLowerCase() === pkg.ecosystem.toLowerCase();

        if (nameMatches && ecosystemMatches) {
          // Check if package version is in affected versions using semver
          const isAffected = vul.affectedVersions
            ?.flatMap((affectedVersion) => affectedVersion.split(","))
            .flat()
            .some((affectedVersion) => {
              try {
                // Validate the package version first
                const packageVersion = semver.valid(semver.coerce(pkg.version));
                if (!packageVersion) {
                  // If package version is not valid semver, fall back to exact string match
                  return (
                    affectedVersion === pkg.version ||
                    affectedVersion.includes(pkg.version)
                  );
                }

                // Clean and normalize the affected version string
                // Handle comma-separated ranges like ">= 14.3.0-canary.77, < 15.0.5"
                const normalizedRange = affectedVersion.trim();

                // semver.satisfies() handles comma-separated ranges natively
                // Comma-separated ranges are treated as AND conditions (e.g., ">=1.0.0, <2.0.0")
                if (semver.validRange(normalizedRange)) {
                  // Use semver.satisfies to check if package version matches the range
                  // This works for single ranges, comma-separated ranges, and complex expressions
                  return semver.satisfies(packageVersion, normalizedRange);
                }

                // If not a valid range, try to parse it as a version and compare
                const rangeVersion = semver.valid(
                  semver.coerce(normalizedRange)
                );
                if (rangeVersion) {
                  return semver.eq(packageVersion, rangeVersion);
                }

                // Fallback: check for exact string match or substring match
                return (
                  normalizedRange === pkg.version ||
                  normalizedRange.includes(pkg.version)
                );
              } catch (error) {
                // If semver parsing fails, fall back to exact string match
                console.warn(
                  `Version comparison failed for ${pkg.version} and ${affectedVersion}:`,
                  error
                );
                return (
                  affectedVersion === pkg.version ||
                  affectedVersion.includes(pkg.version)
                );
              }
            });

          // If no affectedVersions specified, consider it a match if names match
          if (
            isAffected ||
            !vul.affectedVersions ||
            vul.affectedVersions.length === 0
          ) {
            matchedVuls.push(vul);
          }
        }
      });

      if (matchedVuls.length > 0) {
        matches.push({
          package: pkg,
          matchedVulnerabilities: matchedVuls
        });
      }
    });

    return matches;
  }, [packages, vulnerabilities]);

  // Show loading state
  if (loading) {
    return <></>;
  }

  // Show error state (non-blocking, just log it)
  if (error) {
    console.warn("Package vulnerability matcher error:", error);
  }

  // Don't render if no packages or no matches
  if (packages.length === 0 || matchedPackages.length === 0) {
    return null;
  }

  const getSeverityVariant = (severity: string) => {
    switch (severity.toUpperCase()) {
      case "CRITICAL":
        return "danger";
      case "HIGH":
        return "warning";
      case "MEDIUM":
        return "info";
      case "LOW":
        return "success";
      default:
        return "secondary";
    }
  };

  return (
    <div className='package-vulnerability-matcher mb-4'>
      <Alert variant='danger' className='mb-0 border-3'>
        <Alert.Heading className='d-flex align-items-center mb-3'>
          <i
            className='bi bi-exclamation-triangle-fill me-2'
            aria-hidden='true'
          ></i>
          <strong>Vulnerable Packages Detected</strong>
        </Alert.Heading>
        <p className='mb-3'>
          The following packages in your project have known vulnerabilities:
        </p>

        {matchedPackages.map((match, index) => (
          <Card
            key={`${match.package.name}-${match.package.version}-${index}`}
            className='mb-3 border-danger border-2'
            style={{ backgroundColor: "#fff5f5" }}
          >
            <Card.Body>
              <div className='d-flex justify-content-between align-items-start mb-2'>
                <div>
                  <h5 className='mb-1 fw-bold text-danger'>
                    <i className='bi bi-box-seam me-2' aria-hidden='true'></i>
                    {match.package.name}
                  </h5>
                  <p className='mb-0 text-muted small'>
                    Version: <strong>{match.package.version}</strong>
                    {match.package.ecosystem && (
                      <>
                        {" â€¢ "}
                        Ecosystem:{" "}
                        <strong>
                          {ECOSYSTEM_NAME[
                            match.package.ecosystem.toLowerCase() as keyof typeof ECOSYSTEM_NAME
                          ] || match.package.ecosystem}
                        </strong>
                      </>
                    )}
                  </p>
                </div>
                <Badge bg='danger' className='fs-6 px-3 py-2'>
                  {match.matchedVulnerabilities.length}{" "}
                  {match.matchedVulnerabilities.length === 1
                    ? "Vulnerability"
                    : "Vulnerabilities"}
                </Badge>
              </div>

              <div className='mt-3'>
                <h6 className='mb-2 fw-semibold'>Matched Vulnerabilities:</h6>
                <div className='d-flex flex-column gap-2'>
                  {match.matchedVulnerabilities.map((vul) => (
                    <div
                      key={vul.id}
                      className='p-2 border border-danger rounded'
                      style={{ backgroundColor: "#ffe6e6" }}
                    >
                      <div className='d-flex justify-content-between align-items-start'>
                        <div className='flex-grow-1'>
                          <div className='d-flex align-items-center gap-2 mb-1'>
                            <Badge
                              bg={getSeverityVariant(vul.severity)}
                              className='text-capitalize'
                            >
                              {vul.severity}
                            </Badge>
                            {vul.cveId || vul.cve_id ? (
                              <span className='small text-muted'>
                                CVE: {vul.cveId || vul.cve_id}
                              </span>
                            ) : null}
                          </div>
                          {vul.summary && (
                            <p className='mb-1 small'>{vul.summary}</p>
                          )}
                          {vul.affectedVersions &&
                            vul.affectedVersions.length > 0 && (
                              <p className='mb-0 small text-muted'>
                                <strong>Affected Versions:</strong>{" "}
                                {vul.affectedVersions.join(", ")}
                              </p>
                            )}
                        </div>
                        {onVulnerabilityClick && (
                          <Button
                            variant='outline-danger'
                            size='sm'
                            onClick={() => onVulnerabilityClick(vul)}
                            className='ms-2'
                            aria-label={`View details for vulnerability ${vul.id}`}
                          >
                            <i
                              className='bi bi-arrow-right'
                              aria-hidden='true'
                            ></i>
                          </Button>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </Card.Body>
          </Card>
        ))}
      </Alert>
    </div>
  );
}
