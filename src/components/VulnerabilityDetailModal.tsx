import { IVulnerabilityType } from "@/types/vulnerability";
import { useEffect, useRef } from "react";
import { Button, Modal } from "react-bootstrap";
import VulnerabilityDetailContent from "./VulnerabilityDetailContent";

interface VulnerabilityDetailModalProps {
  vulnerability: IVulnerabilityType | null;
  isOpen: boolean;
  onClose: () => void;
}

const severityVariants = {
  CRITICAL: "danger",
  HIGH: "warning",
  MEDIUM: "info",
  LOW: "success"
} as const;

const statusVariants = {
  ACTIVE: "danger",
  RESOLVED: "success",
  MITIGATED: "primary"
} as const;

export default function VulnerabilityDetailModal({
  vulnerability,
  isOpen,
  onClose
}: VulnerabilityDetailModalProps) {
  const modalBodyRef = useRef<HTMLDivElement>(null);
  const modalRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (isOpen && modalRef.current) {
      // Handle Escape key
      const handleEscape = (e: KeyboardEvent) => {
        if (e.key === "Escape") {
          onClose();
        }
      };

      document.addEventListener("keydown", handleEscape);

      return () => {
        document.removeEventListener("keydown", handleEscape);
      };
    }
  }, [isOpen, onClose]);

  if (!vulnerability) return null;

  const formatCVSSScore = (cvss: any) => {
    if (!cvss) return null;
    return {
      score: cvss.score || cvss.cvss_v3?.score,
      vector: cvss.vector_string || cvss.cvss_v3?.vector_string
    };
  };

  return (
    <Modal
      show={isOpen}
      onHide={onClose}
      fullscreen
      className='vulnerability-detail-modal'
      aria-modal='true'
      role='dialog'
      aria-labelledby='modal-title'
      aria-describedby='modal-description'
    >
      <div ref={modalRef}>
        <Modal.Header className='bg-primary text-white'>
          <Modal.Title id='modal-title' className='d-flex align-items-center'>
            <i className='bi bi-shield-exclamation me-2' aria-hidden='true'></i>
            Vulnerability Details
          </Modal.Title>
          <Button
            variant='outline-light'
            size='sm'
            onClick={onClose}
            className='p-1'
            aria-label='Close vulnerability details modal'
          >
            <i className='bi bi-x-lg' aria-hidden='true'></i>
          </Button>
        </Modal.Header>

        <Modal.Body
          className='p-3 small mb-5'
          ref={modalBodyRef}
          id='modal-description'
        >
          <VulnerabilityDetailContent vulnerability={vulnerability} />
        </Modal.Body>
      </div>
    </Modal>
  );
}
