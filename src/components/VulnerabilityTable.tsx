"use client";
import { EPSSData, formatRelativeTime } from "@/utilities/util";
import { useEffect, useRef, useState } from "react";
import { Table } from "react-bootstrap";

import { IVulnerabilityType } from "@/types/vulnerability";
import { ECOSYSTEM_COLOR, ECOSYSTEM_NAME } from "@/utilities/constants";
import { AdvisoryDetailLink } from "./shared/AdvisoryDetailLink";
import { PackageDetailLink } from "./shared/PackageDetailLink";
import {
  AffectedVersionTags,
  CountPill,
  RenderEPSS
} from "./shared/UtilityComponents";

interface VulnerabilityTableProps {
  vulnerabilities: IVulnerabilityType[];
  onVulnerabilityClick?: (vulnerability: IVulnerabilityType) => void;
}

const severityVariants = {
  CRITICAL: "danger",
  HIGH: "warning",
  MEDIUM: "info",
  LOW: "success"
} as const;

const statusVariants = {
  ACTIVE: "danger",
  RESOLVED: "success",
  MITIGATED: "primary"
} as const;

export default function VulnerabilityTable({
  vulnerabilities,
  onVulnerabilityClick
}: VulnerabilityTableProps) {
  const scrollContainerRef = useRef<HTMLDivElement>(null);
  const topScrollbarRef = useRef<HTMLDivElement>(null);
  const [isDragging, setIsDragging] = useState(false);
  const [hasHorizontalScroll, setHasHorizontalScroll] = useState(false);
  const dragStartRef = useRef({ x: 0, scrollLeft: 0 });
  const dragTargetRef = useRef<HTMLElement | null>(null);

  useEffect(() => {
    const scrollContainer = scrollContainerRef.current;
    const topScrollbar = topScrollbarRef.current;

    if (!scrollContainer || !topScrollbar) return;

    // Ensure columns with width styles also have min-width to prevent shrinking
    const table = scrollContainer.querySelector("table");
    if (table) {
      const headers = table.querySelectorAll("th[style*='width']");
      headers.forEach((header) => {
        const htmlHeader = header as HTMLElement;
        const width = htmlHeader.style.width;
        if (width && !htmlHeader.style.minWidth) {
          htmlHeader.style.minWidth = width;
        }
      });
    }

    // Sync top scrollbar with main scroll container
    const handleScroll = () => {
      if (topScrollbar) {
        topScrollbar.scrollLeft = scrollContainer.scrollLeft;
      }
    };

    // Sync main scroll container with top scrollbar
    const handleTopScroll = () => {
      if (scrollContainer) {
        scrollContainer.scrollLeft = topScrollbar.scrollLeft;
      }
    };

    scrollContainer.addEventListener("scroll", handleScroll);
    topScrollbar.addEventListener("scroll", handleTopScroll);

    // Set initial scrollbar width and sync content width
    const updateScrollbarWidth = () => {
      if (scrollContainer && topScrollbar) {
        const hasScroll =
          scrollContainer.scrollWidth > scrollContainer.clientWidth;
        setHasHorizontalScroll(hasScroll);
        topScrollbar.style.display = hasScroll ? "block" : "none";

        // Sync the scrollbar content width with the scroll container
        const scrollbarContent = topScrollbar.querySelector(
          ".vulnerability-table-top-scrollbar-content"
        ) as HTMLElement;
        if (scrollbarContent) {
          scrollbarContent.style.width = `${scrollContainer.scrollWidth}px`;
        }
      }
    };

    updateScrollbarWidth();

    // Update on resize
    const resizeObserver = new ResizeObserver(updateScrollbarWidth);
    resizeObserver.observe(scrollContainer);

    return () => {
      scrollContainer.removeEventListener("scroll", handleScroll);
      topScrollbar.removeEventListener("scroll", handleTopScroll);
      resizeObserver.disconnect();
    };
  }, [vulnerabilities]);

  // Mouse drag to scroll functionality - only enable if horizontal scroll is available
  useEffect(() => {
    const scrollContainer = scrollContainerRef.current;
    if (!scrollContainer || !hasHorizontalScroll) return;

    const handleMouseDown = (e: MouseEvent) => {
      // Don't start drag on fixed columns or clickable elements
      const target = e.target as HTMLElement;
      if (
        target.closest(".fixed-first-column") ||
        target.closest(".fixed-second-column") ||
        target.closest("a") ||
        target.closest("button") ||
        target.closest("input") ||
        target.closest("select")
      ) {
        return;
      }

      // Only start drag on left mouse button
      if (e.button !== 0) return;

      setIsDragging(true);
      dragStartRef.current = {
        x: e.pageX,
        scrollLeft: scrollContainer.scrollLeft
      };
      dragTargetRef.current = target;
      scrollContainer.style.cursor = "grabbing";
      scrollContainer.style.userSelect = "none";
      e.preventDefault();
    };

    const handleMouseMove = (e: MouseEvent) => {
      if (!isDragging) return;

      const x = e.pageX;
      const walk = (x - dragStartRef.current.x) * 2; // Multiply by 2 for faster scrolling
      scrollContainer.scrollLeft = dragStartRef.current.scrollLeft - walk;

      // Also update top scrollbar
      const topScrollbar = topScrollbarRef.current;
      if (topScrollbar) {
        topScrollbar.scrollLeft = scrollContainer.scrollLeft;
      }
    };

    const handleMouseUp = () => {
      if (isDragging) {
        setIsDragging(false);
        if (scrollContainer) {
          scrollContainer.style.cursor = "";
          scrollContainer.style.userSelect = "";
        }
        dragTargetRef.current = null;
      }
    };

    const handleMouseLeave = () => {
      if (isDragging) {
        setIsDragging(false);
        if (scrollContainer) {
          scrollContainer.style.cursor = "";
          scrollContainer.style.userSelect = "";
        }
        dragTargetRef.current = null;
      }
    };

    scrollContainer.addEventListener("mousedown", handleMouseDown);
    document.addEventListener("mousemove", handleMouseMove);
    document.addEventListener("mouseup", handleMouseUp);
    scrollContainer.addEventListener("mouseleave", handleMouseLeave);

    return () => {
      scrollContainer.removeEventListener("mousedown", handleMouseDown);
      document.removeEventListener("mousemove", handleMouseMove);
      document.removeEventListener("mouseup", handleMouseUp);
      scrollContainer.removeEventListener("mouseleave", handleMouseLeave);
    };
  }, [isDragging, hasHorizontalScroll]);

  return (
    <div className='vulnerability-table-wrapper'>
      <div ref={topScrollbarRef} className='vulnerability-table-top-scrollbar'>
        <div className='vulnerability-table-top-scrollbar-content'></div>
      </div>
      <div
        ref={scrollContainerRef}
        className={`table-responsive border rounded vulnerability-table-container ${
          isDragging ? "dragging" : ""
        } ${hasHorizontalScroll ? "scrollable" : ""}`}
      >
        <Table striped hover className='mb-0 table-hover'>
          <thead className='table-dark'>
            <tr>
              <th className='fixed-first-column'>#</th>
              <th className='fixed-second-column'>Title</th>
              <th style={{ width: "300px" }}>Package</th>
              <th style={{ width: "80px" }}>Source</th>
              <th style={{ width: "100px" }}>ID</th>
              <th style={{ width: "180px" }}>Affected Version</th>
              <th style={{ width: "180px" }}>Fixed Version</th>
              <th style={{ width: "100px" }}>Severity</th>
              <th style={{ width: "80px" }}>EPSS</th>
              <th style={{ width: "80px" }}>Score/10</th>

              <th style={{ width: "120px" }}>Published</th>
            </tr>
          </thead>
          <tbody>
            {vulnerabilities.map((vulnerability, index) => (
              <tr key={vulnerability.id}>
                <td className='fixed-first-column'>
                  <span className='small'> {index + 1}.</span>
                </td>
                <td className='fixed-second-column'>
                  <div className='fw-semibold text-dark'>
                    <div className='small'>
                      <AdvisoryDetailLink
                        vulnerability={vulnerability}
                        onVulnerabilityClick={onVulnerabilityClick}
                      />
                    </div>
                  </div>

                  {/* <div className='d-flex flex-justify-start gap-3'>
                  {vulnerability.cveId ? (
                    <CountPill
                      count={<span className='small'>vulnerability.cveId</span>}
                      label={<span className='small'>CVE</span>}
                      variant='grey'
                    />
                  ) : (
                    <></>
                  )}

                  
                </div> */}
                </td>

                <td>
                  <div className='package-name-cell-content'>
                    <PackageDetailLink
                      ecoSystem={vulnerability.ecosystem}
                      packageName={vulnerability.packageName}
                    />
                  </div>
                </td>
                <td>
                  <CountPill
                    count={
                      ECOSYSTEM_NAME[vulnerability.ecosystem] ??
                      vulnerability.ecosystem
                    }
                    variant={ECOSYSTEM_COLOR[vulnerability.ecosystem] ?? "grey"}
                  />
                </td>

                <td>
                  {vulnerability.id ? (
                    <CountPill
                      count={
                        <span className='small'>
                          {vulnerability.detailURL ? (
                            <a
                              href={vulnerability.detailURL}
                              target='_blank'
                              className='alt-link text-decoration-none'
                            >
                              {vulnerability.id}
                            </a>
                          ) : (
                            vulnerability.id
                          )}
                        </span>
                      }
                      label={
                        <span className='small'>
                          {vulnerability.source ?? "ID"}
                        </span>
                      }
                      variant='grey'
                    />
                  ) : (
                    <></>
                  )}
                </td>

                <td>
                  {vulnerability.affectedVersions && (
                    <AffectedVersionTags
                      affectedVersions={vulnerability.affectedVersions}
                    />
                  )}
                </td>

                <td>
                  {vulnerability.patchedVersion ? (
                    <PackageDetailLink
                      ecoSystem={vulnerability.ecosystem}
                      packageName={vulnerability.packageName}
                      label={vulnerability.patchedVersion}
                      version={vulnerability.patchedVersion}
                      className='text-green small text-decoration-none'
                    />
                  ) : (
                    <span className='text-high small'>No Fix Available</span>
                  )}
                </td>
                <td>
                  <span
                    className={`text-${vulnerability.severity.toLowerCase()} small`}
                  >
                    {vulnerability.severity}
                  </span>
                </td>
                <td>
                  {vulnerability?.epss?.percentage ? (
                    <RenderEPSS
                      epss={vulnerability?.epss as EPSSData}
                      displayType='table'
                    />
                  ) : (
                    <></>
                  )}
                </td>
                <td className='text-center'>
                  {vulnerability.score ? (
                    <div
                      className='flex align-items-center text-muted small'
                      title='Score'
                    >
                      <i className='bi bi-shield-exclamation me-1'></i>
                      <strong className='text-dark'>
                        {vulnerability.score}
                      </strong>
                    </div>
                  ) : (
                    <></>
                  )}
                </td>

                <td>
                  <div className='small text-muted'>
                    {formatRelativeTime(vulnerability.publishedDate)}
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </Table>
      </div>
    </div>
  );
}
